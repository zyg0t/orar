<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orar XII E</title>
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <style>
    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        line-height: 1;
        color: #e0e0e0;
        text-align: center;
        background-color: #07090e;
        margin: 0;
        padding: 20px 20px 60px 20px;
    }
    #status-container { max-width: 1000px; margin: 30px auto; padding: 15px; }
    #loading-status { font-weight: 500; color: #888; }
    #schedules-container { display: flex; flex-direction: column; gap: 0; margin-top: 20px; }
    .schedule-item { background-color: transparent; padding: 24px; margin: 0 auto; width: 95%; max-width: 1000px; box-sizing: border-box; }
    .schedule-item h2 { color: #e0e0e0; font-weight: 500; margin-top: 0; font-size: 1.5em; }
    .schedule-item canvas { display: block; margin: 0 auto; width: 100%; height: auto; border-radius: 4px; }
    @media (max-width: 600px) {
        body { padding: 10px 10px 30px 10px; }
        .schedule-item { padding: 4px; width: 100%; }
    }
</style>
</head>
<body>
    <div id="status-container">
        <div id="loading-status">➤ Inițializare...</div>
    </div>
    <div id="schedules-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const orarPageUrl = 'https://www.colegiulasachi.ro/orar.html';
const proxies = [
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
];

const searchText = 'Lamatic Lidia';
const today = new Date();
const CACHE_KEY = 'orar-cache-v3';
const CACHE_TTL = 12 * 60 * 60 * 1000;

const loadingStatus = document.getElementById('loading-status');
const schedulesContainer = document.getElementById('schedules-container');
const statusContainer = document.getElementById('status-container');
const parser = new DOMParser();

const normalize = s => s.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
const needle = normalize(searchText);

async function smartFetch(url) {
    for (let proxy of proxies) {
        try {
            const res = await fetch(proxy(url));
            if (res.ok) return res;
        } catch (e) { continue; }
    }
    throw new Error("Toate proxy-urile au eșuat (403/Limită).");
}

async function findAndDisplayAllSchedules() {
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
        const { timestamp, data } = JSON.parse(cached);
        if (Date.now() - timestamp < CACHE_TTL) {
            loadingStatus.textContent = '➤ Din cache';
            return renderFromCache(data);
        }
    }
    fetchAndCache();
}

async function fetchAndCache() {
    try {
        loadingStatus.textContent = '➤ Accesare server...';
        const res = await smartFetch(orarPageUrl);
        const html = await res.text();
        const schedules = parseSchedules(html);

        if (!schedules.length) {
            loadingStatus.textContent = '➤ Orar indisponibil.';
            return;
        }

        sortSchedules(schedules);
        const data = [];
        for (const s of schedules) {
            loadingStatus.textContent = `➤ Căutare în ${s.title}...`;
            const pageNumber = await findPageNumber(s.url);
            if (pageNumber) data.push({ ...s, pageNumber });
        }

        localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data }));
        renderFromCache(data);
    } catch (e) {
        loadingStatus.textContent = '➤ ' + e.message;
    }
}

function parseSchedules(html) {
    return html.split(/_+[\*_]*_+/g).map(block => {
        if (block.trim().length < 10) return null;
        const doc = parser.parseFromString(block, 'text/html');
        const link = [...doc.querySelectorAll('a')].find(a => a.textContent.includes('Fiecare clasa'));
        if (!link) return null;
        const text = doc.body.textContent;
        const m = text.match(/(\d{1,2})\s*-\s*(\d{1,2})\.(\d{2})\.(\d{4})/);
        if (!m) return null;
        const [, sd, ed, mo, y] = m.map(Number);
        const titleMatch = text.match(/S\d+/);
        return {
            url: new URL(link.getAttribute('href'), orarPageUrl).href,
            title: titleMatch ? `${titleMatch[0]} (${sd}-${ed}.${mo}.${y})` : `(${sd}-${ed}.${mo}.${y})`,
            startDate: new Date(y, mo - 1, sd),
            endDate: new Date(y, mo - 1, ed, 23, 59, 59)
        };
    }).filter(Boolean);
}

function sortSchedules(s) {
    s.sort((a, b) => {
        const now = today.getTime();
        const cat = x => (x.startDate <= now && now <= x.endDate) ? 1 : (x.startDate > now ? 2 : 3);
        const catA = cat(a), catB = cat(b);
        return catA !== catB ? catA - catB : (catA === 3 ? b.startDate - a.startDate : a.startDate - b.startDate);
    });
}

async function findPageNumber(url) {
    try {
        const res = await smartFetch(url);
        const buffer = await res.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            if (normalize(content.items.map(t => t.str).join(' ')).includes(needle)) return i;
        }
    } catch (e) { console.error(e); }
    return null;
}

async function renderFromCache(data) {
    statusContainer.style.display = 'none';
    for (const item of data) {
        try {
            const res = await smartFetch(item.url);
            const buffer = await res.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
            const page = await pdf.getPage(item.pageNumber);
            renderSchedule(item.title, page, item.startDate, item.endDate);
        } catch (e) { console.error(e); }
    }
}

async function renderSchedule(title, page, startDate, endDate) {
    const div = document.createElement('div'), h2 = document.createElement('h2'), canvas = document.createElement('canvas');
    const sDate = new Date(startDate), eDate = new Date(endDate);
    const ctx = canvas.getContext('2d', {willReadFrequently: true});
    div.className = 'schedule-item';
    const isCur = sDate <= today && today <= eDate, isFut = sDate > today;
    h2.style.color = isCur ? '#4caf50' : (isFut ? '#2196f3' : '#ffffff');
    h2.textContent = `${isCur ? 'Orarul curent' : isFut ? 'Orarul următor' : 'Orarul precedent'} ➤ ${title}`;
    const vp = page.getViewport({scale: 2.0});
    canvas.width = vp.width; canvas.height = vp.height;
    div.append(h2, canvas);
    schedulesContainer.appendChild(div);
    await page.render({canvasContext: ctx, viewport: vp}).promise;
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height), d = imgData.data;
    for (let i = 0; i < d.length; i += 4) {
        if (d[i] > 220 && d[i+1] > 220 && d[i+2] > 220) d[i+3] = 0;
        else { d[i] = 255 - d[i] || 7; d[i+1] = 255 - d[i+1] || 9; d[i+2] = 255 - d[i+2] || 14; }
    }
    ctx.putImageData(imgData, 0, 0);
}

findAndDisplayAllSchedules();
</script>
</body>
</html>
