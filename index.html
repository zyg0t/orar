<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orar XII E</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            color: #e0e0e0;
            text-align: center;
            background-color: #121212;
            margin: 0;
            padding: 20px 20px 60px 20px;
        }
        h1 {
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 0;
            font-size: 2.5em;
        }
        #subtitle-date {
            color: #888;
            font-weight: 400;
            margin-top: 4px;
            font-size: 1.1em;
        }
        #status-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 15px;
            background-color: transparent;
        }
        #loading-status {
            font-weight: 500;
            color: #888;
        }
        #schedules-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
            margin-top: 50px;
        }
        .schedule-item {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
            margin: 0 auto;
            width: 95%;
            max-width: 800px;
            box-sizing: border-box;
        }
        .schedule-item h2 {
            color: #e0e0e0;
            font-weight: 500;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-top: 0;
            font-size: 1.2em;
        }
        .schedule-item canvas {
            display: block;
            margin: 0 auto;
            width: 100%;
            height: auto;
            border-radius: 4px;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px 10px 30px 10px;
            }
            .schedule-item {
                padding: 15px;
                width: 100%;
            }
            h1 {
                font-size: 2em;
            }
            #schedules-container {
                gap: 20px;
                margin-top: 25px;
            }
        }
    </style>
</head>
<body>
    <h1>Orar XII E</h1>
    <h2 id="subtitle-date"></h2>
    <div id="status-container">
        <div id="loading-status">1/3 init</div>
    </div>
    <div id="schedules-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const orarPageUrl = 'https://www.colegiulasachi.ro/orar.html';
const proxyUrl = 'https://corsproxy.io/?';
const searchText = 'Lamatic Lidia';
const today = new Date();

const CACHE_KEY = 'orar-xii-e-cache-v2';
const CACHE_TTL = 12 * 60 * 60 * 1000;

const loadingStatus = document.getElementById('loading-status');
const schedulesContainer = document.getElementById('schedules-container');
const statusContainer = document.getElementById('status-container');
const parser = new DOMParser();

document.getElementById('subtitle-date').textContent =
    today.toLocaleDateString('ro-RO', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

const normalize = s =>
    s.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");

const needle = normalize(searchText);

const proxiedFetch = url =>
    fetch(proxyUrl + encodeURIComponent(url));

async function findAndDisplayAllSchedules() {
    const cached = localStorage.getItem(CACHE_KEY);

    if (cached) {
        const { timestamp, data } = JSON.parse(cached);
        if (Date.now() - timestamp < CACHE_TTL) {
            loadingStatus.textContent = 'loaded from cache';
            return renderFromCache(data);
        }
    }
    fetchAndCache();
}

async function fetchAndCache() {
    try {
        loadingStatus.textContent = '2/3 download';
        const res = await proxiedFetch(orarPageUrl);
        if (!res.ok) throw new Error(`proxy error: ${res.statusText}`);

        loadingStatus.textContent = 'analyzing';
        const html = await res.text();
        const schedules = parseSchedules(html);

        if (!schedules.length) {
            loadingStatus.textContent = 'error, check console';
            console.error('Could not parse any schedule blocks. Make sure the "***" separator exists on the source page.');
            return;
        }

        loadingStatus.textContent = '3/3 sort';
        sortSchedules(schedules);

        const data = [];
        for (const { url, title, startDate, endDate } of schedules) {
            const pageNumber = await findPageNumber(url);
            if (pageNumber) data.push({ url, title, pageNumber, startDate, endDate });
        }

        localStorage.setItem(CACHE_KEY, JSON.stringify({
            timestamp: Date.now(),
            data
        }));

        renderFromCache(data);

    } catch (e) {
        loadingStatus.textContent = 'error: ' + e.message;
        console.error(e);
    }
}

function parseSchedules(html) {
    return html
        .split(/_+[\*_]*_+/g)
        .map(block => {
            if (block.trim().length < 10) return null;

            const doc = parser.parseFromString(block, 'text/html');
            const link = [...doc.querySelectorAll('a')]
                .find(a => a.textContent.trim().includes('Fiecare clasa'));
            if (!link) return null;

            const text = doc.body.textContent;
            const m = text.match(/(\d{1,2})\s*-\s*(\d{1,2})\.(\d{2})\.(\d{4})/);
            if (!m) return null;

            const [, sd, ed, mo, y] = m.map(Number);
            const titleMatch = text.match(/S\d+/);
            const date = `(${sd}-${ed}.${mo}.${y})`;

            return {
                url: new URL(link.getAttribute('href'), orarPageUrl).href,
                title: titleMatch ? `${titleMatch[0]} ${date}` : date,
                startDate: new Date(y, mo - 1, sd),
                endDate: new Date(y, mo - 1, ed, 23, 59, 59)
            };
        })
        .filter(Boolean);
}

function sortSchedules(s) {
    s.sort((a, b) => {
        const todayMs = today.getTime();

        const getCategory = (schedule) => {
            if (schedule.startDate.getTime() <= todayMs && todayMs <= schedule.endDate.getTime()) {
                return 1;
            } else if (schedule.startDate.getTime() > todayMs) {
                return 2;
            } else {
                return 3;
            }
        };

        const categoryA = getCategory(a);
        const categoryB = getCategory(b);

        if (categoryA !== categoryB) {
            return categoryA - categoryB;
        }

        if (categoryA === 1 || categoryA === 2) {
            return a.startDate.getTime() - b.startDate.getTime();
        } else {
            return b.startDate.getTime() - a.startDate.getTime();
        }
    });
}

async function findPageNumber(url) {
    const res = await proxiedFetch(url);
    const pdf = await pdfjsLib.getDocument({ data: await res.arrayBuffer() }).promise;

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const text = normalize(
            (await page.getTextContent()).items.map(t => t.str).join(' ')
        );
        if (text.includes(needle)) return i;
    }
    return null;
}

async function renderFromCache(data) {
    statusContainer.style.display = 'none';

    for (const { url, title, pageNumber, startDate, endDate } of data) {
        const pdf = await pdfjsLib.getDocument(
            proxyUrl + encodeURIComponent(url)
        ).promise;

        const page = await pdf.getPage(pageNumber);
        renderSchedule(title, page, startDate, endDate);
    }
}

async function renderSchedule(title, page, startDate, endDate) {
    const div = document.createElement('div');
    div.className = 'schedule-item';

    const h2 = document.createElement('h2');
    h2.textContent = title;

    const sDate = new Date(startDate);
    const eDate = new Date(endDate);

    if (sDate <= today && today <= eDate) {
        h2.style.color = '#4caf50';
    } else if (sDate > today) {
        h2.style.color = '#2196f3';
    }

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    div.append(h2, canvas);
    schedulesContainer.appendChild(div);

    const vp = page.getViewport({ scale: 1.8 });
    canvas.width = vp.width;
    canvas.height = vp.height;

    await page.render({ canvasContext: ctx, viewport: vp }).promise;
}

findAndDisplayAllSchedules();
</script>

</body>
</html>
